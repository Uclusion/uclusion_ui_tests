
defaults: &defaults
  working_directory: ~/src
  docker:
    - image: circleci/python:3.9-node

orbs:
  aws-cli: circleci/aws-cli@2.0.3
  cypress: cypress-io/cypress@1.29.0
executors:
  with-chrome:
    docker:
      - image: 'cypress/browsers:node16.17.0-chrome106'
version: 2.1

jobs:
  prepare:
    working_directory: ~/src
    docker:
        - image: circleci/ruby:2.7
    steps:
      - aws-cli/install
      - aws-cli/setup:
          aws-region: aws_region
          aws-access-key-id: aws_access_key_id
          aws-secret-access-key: aws_secret_access_key
      - run:
          name: disable strict host checking
          command: |
            mkdir -p ~/.ssh/ && echo -e "Host github.com\n\tStrictHostKeyChecking no\n" > ~/.ssh/config
      - run:
          name: Check out and prepare utils repo
          command: |
            cd ~/
            mkdir circleci_orbs
            git clone git@github.com:Uclusion/circleci_orbs.git ./circleci_orbs
      - run:
          name: delete tusers from Cognito and Dynamodb
          command: |
            cd ~/circleci_orbs/scripts
            ./test_user_deleter.rb --poolId=${pool_id}
            cd ~/circleci_orbs
            python -m scripts.cleanup_test_users
  record:
    <<: *defaults
    steps:
      - run:
          name: disable strict host checking
          command: |
            mkdir -p ~/.ssh/ && echo -e "Host github.com\n\tStrictHostKeyChecking no\n" > ~/.ssh/config
      - run:
          name: Check out and prepare utils repo
          command: |
            cd ~/
            mkdir circleci_orbs
            git clone git@github.com:Uclusion/circleci_orbs.git ./circleci_orbs
      - run:
          name: install latest pip and python modules
          command: |
            sudo pip install --upgrade pip
            pip install --user PyGithub
      - run:
          name: bless
          command: |
            cd ~/circleci_orbs
            python -m scripts.test_and_bless -e ${env_name} -a ${github_token} -u true

workflows:
  create-onboarding:
    jobs:
      - prepare:
          filters:
            tags:
              only: /^onboard_only.*/
            branches:
              ignore: /.*/
          context: stage
      - cypress/install:
          filters:
            tags:
              only: /^onboard_only.*/
            branches:
              ignore: /.*/
      - cypress/run:
          executor: with-chrome
          browser: chrome
          store_artifacts: true
          requires:
            - prepare
            - cypress/install
          install-command: 'npm install --no-optional --unsafe-perm'
          spec: cypress/e2e/create_onboarding.js
          filters:
            tags:
              only: /^onboard_only.*/
            branches:
              ignore: /.*/
          context: stage
      - cypress/run:
          executor: with-chrome
          browser: chrome
          store_artifacts: true
          requires:
            - prepare
            - cypress/install
          install-command: 'npm install --no-optional --unsafe-perm'
          spec: cypress/e2e/create_onboarding1.js
          filters:
            tags:
              only: /^onboard_only.*/
            branches:
              ignore: /.*/
          context: stage
  create-demo:
    jobs:
      - prepare:
          filters:
            tags:
              only: /^demo_only.*/
            branches:
              ignore: /.*/
          context: stage
      - cypress/install:
          filters:
            tags:
              only: /^demo_only.*/
            branches:
              ignore: /.*/
      - cypress/run:
          executor: with-chrome
          browser: chrome
          store_artifacts: true
          requires:
            - prepare
            - cypress/install
          install-command: 'npm install --no-optional --unsafe-perm'
          spec: cypress/e2e/create_demo.js
          filters:
            tags:
              only: /^demo_only.*/
            branches:
              ignore: /.*/
          context: stage
      - cypress/run:
          executor: with-chrome
          browser: chrome
          store_artifacts: true
          requires:
            - prepare
            - cypress/install
          install-command: 'npm install --no-optional --unsafe-perm'
          spec: cypress/e2e/create_demo1.js
          filters:
            tags:
              only: /^demo_only.*/
            branches:
              ignore: /.*/
          context: stage
      - cypress/run:
          executor: with-chrome
          browser: chrome
          store_artifacts: true
          requires:
            - prepare
            - cypress/install
          install-command: 'npm install --no-optional --unsafe-perm'
          spec: cypress/e2e/create_demo2.js
          filters:
            tags:
              only: /^demo_only.*/
            branches:
              ignore: /.*/
          context: stage
      - cypress/run:
          executor: with-chrome
          browser: chrome
          store_artifacts: true
          requires:
            - prepare
            - cypress/install
          install-command: 'npm install --no-optional --unsafe-perm'
          spec: cypress/e2e/create_demo3.js
          filters:
            tags:
              only: /^demo_only.*/
            branches:
              ignore: /.*/
          context: stage
  test-stage:
    jobs:
      - prepare:
          filters:
            tags:
              only: /^stage_only.*/
            branches:
              ignore: /.*/
          context: stage
      - cypress/install:
          filters:
            tags:
              only: /^stage_only.*/
            branches:
              ignore: /.*/
      - cypress/run:
          store_artifacts: true
          requires:
            - prepare
            - cypress/install
          install-command: 'npm install --no-optional --unsafe-perm'
          spec: cypress/e2e/create_market.js
          filters:
            tags:
              only: /^stage_only.*/
            branches:
              ignore: /.*/
          context: stage
      - record:
          requires:
            - cypress/run
          filters:
            tags:
              only: /^stage_only.*/
            branches:
              ignore: /.*/
          context: stage
  test-dev:
    jobs:
      - prepare:
          filters:
            tags:
              only: /^dev_only.*/
            branches:
              ignore: /.*/
          context: dev
      - cypress/install:
          filters:
            tags:
              only: /^dev_only.*/
            branches:
              ignore: /.*/
      - cypress/run:
          store_artifacts: true
          requires:
            - prepare
            - cypress/install
          install-command: 'npm install --no-optional --unsafe-perm'
          spec: cypress/e2e/create_market.js
          filters:
            tags:
              only: /^dev_only.*/
            branches:
              ignore: /.*/
          context: dev
      - record:
          requires:
            - cypress/run
          filters:
            tags:
              only: /^dev_only.*/
            branches:
              ignore: /.*/
          context: dev
